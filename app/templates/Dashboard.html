<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniLocator - Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/Dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/add_device.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- YouTube-style Loading Bar -->
    <div id="loadingBar" class="loading-bar">
        <div class="loading-progress"></div>
    </div>

    <!-- Mobile Sidebar Toggle -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <i class="fa-solid fa-location-pin"></i>
                <span class="sidebar-logo-text">UniLocator</span>
            </div>
            <button class="sidebar-toggle" id="sidebarClose">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <nav class="sidebar-nav">
            <ul class="sidebar-menu">
                <li class="sidebar-item active">
                    <a href="#" class="sidebar-link" data-page="devices">
                        <i class="fas fa-mobile-alt"></i>
                        <span>Devices</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="#" class="sidebar-link" data-page="map">
                        <i class="fas fa-map"></i>
                        <span>Live Map</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="#" class="sidebar-link" data-page="friends">
                        <i class="fas fa-users"></i>
                        <span>Friends</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="#" class="sidebar-link" data-page="profile">
                        <i class="fas fa-user"></i>
                        <span>Profile</span>
                    </a>
                </li>
                <li class="sidebar-item">
                    <a href="#" class="sidebar-link" data-page="settings">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- <div class="sidebar-footer">
            <div class="upgrade-card">
                <div class="upgrade-icon">
                    <i class="fas fa-crown"></i>
                </div>
                <h4>Upgrade to Pro</h4>
                <p>Unlock advanced features and unlimited devices</p>
                <button class="upgrade-btn">
                    <i class="fas fa-arrow-up"></i>
                    Upgrade Now
                </button>
            </div>
        </div> -->
    </aside>

    <!-- Main Content -->
    <div class="main-wrapper">
        <!-- Top Header -->
        <header class="top-header">
            <div class="header-left">
                <button class="sidebar-toggle" id="sidebarToggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
            <div class="header-right">
                <span class="user-name" id="navbar-username"></span>
                <div class="user-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="main-content">
            <div class="content-wrapper">
                <!-- Devices Section (shown when Devices is active) -->
                <div id="devices-page" class="page-content active">
                    <h1 class="page-title">Devices</h1>
                    <div class="page-content-inner">
                        <!-- Quick Actions -->
                        <div class="devices-quick-actions">
                            <button class="quick-action-btn" id="addDeviceBtn">
                                <i class="fas fa-plus"></i>
                                <span>Add Device</span>
                            </button>
                            <button class="quick-action-btn" id="createGroupBtn">
                                <i class="fas fa-users"></i>
                                <span>Create Group</span>
                            </button>
                            <button class="quick-action-btn" id="scanQRBtn">
                                <i class="fas fa-qrcode"></i>
                                <span>Scan QR</span>
                            </button>
                        </div>

                        <!-- My Devices Section -->
                        <div class="devices-section">
                            <div class="devices-section-header">
                                <div class="section-title">
                                    <h2>My Devices</h2>
                                    <span class="device-count" id="myDevicesCount">Loading...</span>
                                </div>
                                <div class="section-actions">
                                    <button class="filter-btn" data-filter="all">All</button>
                                    <button class="filter-btn" data-filter="online">Online</button>
                                    <button class="filter-btn" data-filter="offline">Offline</button>
                                </div>
                            </div>
                            <div class="devices-grid" id="myDevicesGrid">
                                <!-- My devices will be loaded dynamically -->
                                <div class="loading-placeholder">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <span>Loading your devices...</span>
                                </div>
                            </div>
                        </div>

                        <!-- Individual Devices Section -->
                        <div class="devices-section">
                            <div class="devices-section-header">
                                <div class="section-title">
                                    <h2>Individual Devices</h2>
                                    <span class="device-count" id="individualDevicesCount">0 devices</span>
                                </div>
                                <button class="add-device-btn" id="addIndividualDeviceBtn">
                                    <i class="fas fa-plus"></i>
                                    <span>Add Device</span>
                                </button>
                            </div>
                            <div class="devices-grid" id="individualDevicesGrid">
                                <div class="empty-state-mini">
                                    <i class="fas fa-mobile-alt"></i>
                                    <p>No individual devices added yet</p>
                                    <button class="add-device-btn-mini">Add Device</button>
                                </div>
                            </div>
                        </div>

                        <!-- Groups Section -->
                        <div class="devices-section">
                            <div class="devices-section-header">
                                <div class="section-title">
                                    <h2>Groups</h2>
                                    <span class="device-count" id="groupsCount">0 groups</span>
                                </div>
                                <button class="add-device-btn" id="createGroupMainBtn">
                                    <i class="fas fa-users-plus"></i>
                                    <span>Create Group</span>
                                </button>
                            </div>
                            <div class="groups-grid" id="groupsGrid">
                                <div class="empty-state-mini">
                                    <i class="fas fa-users"></i>
                                    <p>No groups created yet</p>
                                    <button class="create-group-btn-mini">Create Group</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Live Map Section -->
                <div id="map-page" class="page-content">
                    <h1 class="page-title">Live Map</h1>
                    <div class="page-content-inner">
                        <!-- Map Controls -->
                        <div class="map-controls">
                            <div class="map-filters">
                                <button class="map-filter-btn active" data-filter="all">
                                    <i class="fas fa-globe"></i>
                                    <span>All Devices</span>
                                </button>
                                <button class="map-filter-btn" data-filter="my-devices">
                                    <i class="fas fa-mobile-alt"></i>
                                    <span>My Devices</span>
                                </button>
                                <button class="map-filter-btn" data-filter="groups">
                                    <i class="fas fa-users"></i>
                                    <span>Groups</span>
                                </button>
                                <button class="map-filter-btn" data-filter="friends">
                                    <i class="fas fa-user-friends"></i>
                                    <span>Friends</span>
                                </button>
                            </div>
                            <div class="map-actions">
                                <button class="map-action-btn" id="centerMapBtn">
                                    <i class="fas fa-crosshairs"></i>
                                    <span>Center</span>
                                </button>
                                <button class="map-action-btn" id="refreshMapBtn">
                                    <i class="fas fa-sync-alt"></i>
                                    <span>Refresh</span>
                                </button>
                                <button class="map-action-btn" id="fullscreenMapBtn">
                                    <i class="fas fa-expand"></i>
                                    <span>Fullscreen</span>
                                </button>
                            </div>
                        </div>

                        <!-- Map Container -->
                        <div class="map-container">
                            <div id="liveMap" class="live-map">
                                <!-- Map will be initialized here -->
                                <div class="map-loading">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <span>Loading map...</span>
                                </div>
                            </div>
                            
                            <!-- Device Legend -->
                            <div class="map-legend">
                                <h4>Device Types</h4>
                                <div class="legend-items">
                                    <div class="legend-item">
                                        <div class="legend-marker my-device"></div>
                                        <span>My Devices</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-marker group-device"></div>
                                        <span>Group Devices</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-marker friend-device"></div>
                                        <span>Friend Devices</span>
                                    </div>
                                    <div class="legend-item">
                                        <div class="legend-marker individual-device"></div>
                                        <span>Individual Devices</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Device List Panel -->
                        <div class="map-device-panel" id="mapDevicePanel">
                            <div class="panel-header">
                                <h3>Tracked Devices</h3>
                                <button class="panel-toggle-btn" id="panelToggleBtn">
                                    <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                            <div class="panel-content">
                                <div class="device-search">
                                    <input type="text" placeholder="Search devices..." id="deviceSearchInput">
                                    <i class="fas fa-search"></i>
                                </div>
                                <div class="tracked-devices-list" id="trackedDevicesList">
                                    <!-- Device list will be populated dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Friends Section -->
                <div id="friends-page" class="page-content">
                    <h1 class="page-title">Friends & Social</h1>
                    <div class="page-content-inner">
                        <!-- Friends Navigation -->
                        <div class="friends-nav">
                            <button class="friends-nav-btn active" data-tab="friends">
                                <i class="fas fa-user-friends"></i>
                                <span>Friends</span>
                            </button>
                            <button class="friends-nav-btn" data-tab="groups">
                                <i class="fas fa-users"></i>
                                <span>Groups</span>
                            </button>
                            <button class="friends-nav-btn" data-tab="requests">
                                <i class="fas fa-user-plus"></i>
                                <span>Requests</span>
                                <span class="notification-badge" id="requestsBadge">0</span>
                            </button>
                            <button class="friends-nav-btn" data-tab="search">
                                <i class="fas fa-search"></i>
                                <span>Find Friends</span>
                            </button>
                        </div>

                        <!-- Friends Tab Content -->
                        <div class="friends-tab-content active" id="friends-tab">
                            <div class="friends-header">
                                <div class="friends-stats">
                                    <div class="stat-item">
                                        <span class="stat-number" id="totalFriends">0</span>
                                        <span class="stat-label">Friends</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-number" id="onlineFriends">0</span>
                                        <span class="stat-label">Online</span>
                                    </div>
                                </div>
                                <div class="friends-actions">
                                    <button class="friends-action-btn" id="addFriendBtn">
                                        <i class="fas fa-user-plus"></i>
                                        Add Friend
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Friends List -->
                            <div class="friends-list" id="friendsList">
                                <div class="loading-placeholder">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <span>Loading friends...</span>
                                </div>
                            </div>
                        </div>

                        <!-- Groups Tab Content -->
                        <div class="friends-tab-content" id="groups-tab">
                            <div class="groups-header">
                                <h3>My Groups</h3>
                                <button class="friends-action-btn" id="createSocialGroupBtn">
                                    <i class="fas fa-plus"></i>
                                    Create Group
                                </button>
                            </div>
                            <div class="social-groups-list" id="socialGroupsList">
                                <div class="empty-state-mini">
                                    <i class="fas fa-users"></i>
                                    <p>No groups yet</p>
                                    <button class="create-group-btn-mini">Create Your First Group</button>
                                </div>
                            </div>
                        </div>

                        <!-- Requests Tab Content -->
                        <div class="friends-tab-content" id="requests-tab">
                            <div class="requests-header">
                                <h3>Friend Requests</h3>
                            </div>
                            <div class="requests-list" id="requestsList">
                                <div class="empty-state-mini">
                                    <i class="fas fa-inbox"></i>
                                    <p>No pending requests</p>
                                </div>
                            </div>
                        </div>

                        <!-- Search Tab Content -->
                        <div class="friends-tab-content" id="search-tab">
                            <div class="search-header">
                                <h3>Find Friends</h3>
                                <div class="search-bar">
                                    <input type="text" placeholder="Search by username or email..." id="friendSearchInput">
                                    <button class="search-btn" id="searchFriendsBtn">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="search-results" id="searchResults">
                                <div class="search-placeholder">
                                    <i class="fas fa-search"></i>
                                    <p>Search for friends by username or email</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Window -->
                <div class="chat-window" id="chatWindow">
                    <div class="chat-header">
                        <div class="chat-user-info">
                            <img src="../static/img/user-solid.svg" alt="User" class="chat-avatar" id="chatAvatar">
                            <div class="chat-user-details">
                                <span class="chat-username" id="chatUsername">John Doe</span>
                                <span class="chat-status" id="chatStatus">Online</span>
                            </div>
                        </div>
                        <div class="chat-actions">
                            <button class="chat-action-btn" id="voiceCallBtn" title="Voice Call">
                                <i class="fas fa-phone"></i>
                            </button>
                            <button class="chat-action-btn" id="videoCallBtn" title="Video Call">
                                <i class="fas fa-video"></i>
                            </button>
                            <button class="chat-action-btn" id="chatInfoBtn" title="Chat Info">
                                <i class="fas fa-info-circle"></i>
                            </button>
                            <button class="chat-action-btn" id="closeChatBtn" title="Close Chat">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="chat-messages" id="chatMessages">
                        <!-- Chat messages will be populated here -->
                    </div>
                    
                    <div class="chat-input-area">
                        <div class="chat-input-container">
                            <button class="chat-attachment-btn" id="attachmentBtn">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <input type="text" placeholder="Type a message..." class="chat-input" id="chatInput">
                            <button class="chat-emoji-btn" id="emojiBtn">
                                <i class="fas fa-smile"></i>
                            </button>
                            <button class="chat-send-btn" id="sendMessageBtn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <div class="chat-typing-indicator" id="typingIndicator">
                            <span></span> is typing...
                        </div>
                    </div>
                </div>

                <!-- Call Window -->
                <div class="call-window" id="callWindow">
                    <div class="call-content">
                        <div class="call-user-info">
                            <img src="../static/img/user-solid.svg" alt="User" class="call-avatar" id="callAvatar">
                            <span class="call-username" id="callUsername">John Doe</span>
                            <span class="call-status" id="callStatus">Calling...</span>
                        </div>
                        
                        <div class="call-controls">
                            <button class="call-control-btn mute-btn" id="muteBtn" title="Mute">
                                <i class="fas fa-microphone"></i>
                            </button>
                            <button class="call-control-btn end-call-btn" id="endCallBtn" title="End Call">
                                <i class="fas fa-phone-slash"></i>
                            </button>
                            <button class="call-control-btn video-btn" id="toggleVideoBtn" title="Toggle Video">
                                <i class="fas fa-video"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Profile Section -->
                <div id="profile-page" class="page-content">
                    <h1 class="page-title">Profile</h1>
                    <div class="page-content-inner">
                        <div class="profile-container">
                            <!-- Profile Header -->
                            <div class="profile-header">
                                <div class="profile-avatar-section">
                                    <div class="profile-avatar">
                                        <img src="../static/img/user-solid.svg" alt="User Avatar" id="userAvatar">
                                        <div class="status-indicator online" id="statusIndicator"></div>
                                        <button class="avatar-upload-btn" id="avatarUploadBtn" title="Change Avatar">
                                            <i class="fas fa-camera"></i>
                                        </button>
                                    </div>
                                    <div class="profile-basic-info">
                                        <h2 class="profile-name" id="profileName">Loading...</h2>
                                        <div class="profile-tagline-wrapper">
                                            <input type="text" class="profile-tagline" id="profileTagline" value="Add your tagline here..." placeholder="Add a tagline...">
                                        </div>
                                        <div class="profile-joined">
                                            <i class="fas fa-calendar-alt"></i>
                                            <span id="joinedDate">Member since 2024</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="profile-actions-header">
                                    <button class="share-profile-btn" id="shareProfileBtn">
                                        <i class="fas fa-share-alt"></i>
                                        Share Profile
                                    </button>
                                </div>
                            </div>

                            <!-- Profile Stats Cards -->
                            <div class="profile-stats-grid">
                                <div class="profile-stat-card">
                                    <div class="stat-icon">
                                        <i class="fas fa-mobile-alt"></i>
                                    </div>
                                    <div class="stat-content">
                                        <span class="stat-number" id="totalDevices">0</span>
                                        <span class="stat-label">Connected Devices</span>
                                    </div>
                                </div>
                                <div class="profile-stat-card">
                                    <div class="stat-icon">
                                        <i class="fas fa-map-marker-alt"></i>
                                    </div>
                                    <div class="stat-content">
                                        <span class="stat-number" id="locationsTracked">0</span>
                                        <span class="stat-label">Locations Tracked</span>
                                    </div>
                                </div>
                                <div class="profile-stat-card">
                                    <div class="stat-icon">
                                        <i class="fas fa-calendar-day"></i>
                                    </div>
                                    <div class="stat-content">
                                        <span class="stat-number" id="accountAge">0</span>
                                        <span class="stat-label">Days Active</span>
                                    </div>
                                </div>
                                <div class="profile-stat-card">
                                    <div class="stat-icon">
                                        <i class="fas fa-users"></i>
                                    </div>
                                    <div class="stat-content">
                                        <span class="stat-number" id="groupsJoined">0</span>
                                        <span class="stat-label">Groups Joined</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Profile Content Grid -->
                            <div class="profile-content-grid">
                                <!-- Editable Info Section -->
                                <div class="profile-section">
                                    <h3 class="section-title">
                                        <i class="fas fa-user-edit"></i>
                                        Personal Information
                                    </h3>
                                    <form class="profile-form" id="profileForm">
                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="firstName">First Name</label>
                                                <input type="text" id="firstName" name="firstName" placeholder="Enter first name" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="lastName">Last Name</label>
                                                <input type="text" id="lastName" name="lastName" placeholder="Enter last name" required>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label for="email">Email Address</label>
                                            <input type="email" id="email" name="email" placeholder="Enter email address" required>
                                            <small class="form-help">This email is managed by your Firebase account</small>
                                        </div>
                                        <div class="form-group">
                                            <label for="bio">Bio</label>
                                            <textarea id="bio" name="bio" placeholder="Tell us about yourself..." rows="3"></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label for="location">Location</label>
                                            <input type="text" id="location" name="location" placeholder="City, Country">
                                        </div>
                                    </form>
                                </div>

                                <!-- Recent Activity Section -->
                                <div class="profile-section">
                                    <h3 class="section-title">
                                        <i class="fas fa-history"></i>
                                        Recent Activity
                                    </h3>
                                    <div class="activity-list" id="activityList">
                                        <div class="activity-item loading">
                                            <div class="activity-icon">
                                                <i class="fas fa-spinner fa-spin"></i>
                                            </div>
                                            <div class="activity-content">
                                                <div class="activity-text">Loading recent activity...</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Preferences Section -->
                                <div class="profile-section">
                                    <h3 class="section-title">
                                        <i class="fas fa-cog"></i>
                                        Preferences
                                    </h3>
                                    <div class="preferences-list">
                                        <div class="preference-item">
                                            <div class="preference-info">
                                                <span class="preference-label">Dark Mode</span>
                                                <small class="preference-desc">Enable dark theme across the application</small>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="darkModeToggle" checked>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="preference-item">
                                            <div class="preference-info">
                                                <span class="preference-label">Email Notifications</span>
                                                <small class="preference-desc">Receive device alerts via email</small>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="emailNotificationsToggle" checked>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                        <div class="preference-item">
                                            <div class="preference-info">
                                                <span class="preference-label">Auto-refresh Dashboard</span>
                                                <small class="preference-desc">Automatically update device status</small>
                                            </div>
                                            <label class="switch">
                                                <input type="checkbox" id="autoRefreshToggle" checked>
                                                <span class="slider"></span>
                                            </label>
                                        </div>
                                    </div>
                                </div>


                            </div>

                            <!-- Profile Actions -->
                            <div class="profile-actions">
                                <button class="save-changes-btn" id="saveChangesBtn">
                                    <i class="fas fa-save"></i>
                                    Save Changes
                                </button>
                                <button class="reset-btn" id="resetChangesBtn">
                                    <i class="fas fa-undo"></i>
                                    Reset Changes
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settings-page" class="page-content">
                    <h1 class="page-title">Settings</h1>
                    <div class="page-content-inner">
                        <form class="settings-container" id="settingsForm">
                            <!-- General Section -->
                            <div class="settings-card">
                                <h2 class="settings-section-title">General</h2>
                                <p class="settings-section-desc">Manage general application settings.</p>
                                <div class="settings-row settings-row-flex">
                                    <div class="settings-field">
                                        <label for="themeSelect">Theme</label>
                                        <select id="themeSelect" name="theme">
                                            <option value="dark">Dark</option>
                                            <option value="light">Light</option>
                                            <option value="system">System</option>
                                        </select>
                                    </div>
                                    <div class="settings-field">
                                        <label for="languageSelect">Language</label>
                                        <select id="languageSelect" name="language">
                                            <option value="en">English</option>
                                            <option value="hi">Hindi</option>
                                            <option value="es">Spanish</option>
                                            <option value="fr">French</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Location Sharing Section -->
                            <div class="settings-card">
                                <h2 class="settings-section-title">Location Sharing</h2>
                                <p class="settings-section-desc">Control your location sharing preferences.</p>
                                <div class="settings-row">
                                    <div class="settings-toggle-group">
                                        <div class="settings-toggle-label">
                                            <span>Enable Live Sharing</span>
                                            <small>Allow UniLocator to track your device locations in real-time.</small>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" id="liveSharingToggle" checked>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    <div class="settings-toggle-group">
                                        <div class="settings-toggle-label">
                                            <span>Background Tracking</span>
                                            <small>Allow location updates when the app is in the background.</small>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" id="backgroundTrackingToggle" checked>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    <div class="settings-toggle-group">
                                        <div class="settings-toggle-label">
                                            <span>Auto-pause on Low Battery</span>
                                            <small>Automatically pause location sharing when battery is below 20%.</small>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" id="lowBatteryToggle">
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Notifications Section -->
                            <div class="settings-card">
                                <h2 class="settings-section-title">Notifications</h2>
                                <p class="settings-section-desc">Manage how you receive alerts.</p>
                                <div class="settings-row">
                                    <div class="settings-toggle-group">
                                        <div class="settings-toggle-label">
                                            <span>Friend Requests</span>
                                            <small>Receive alerts for new friend requests.</small>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" id="friendRequestsToggle" checked>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    <div class="settings-toggle-group">
                                        <div class="settings-toggle-label">
                                            <span>Group Invites</span>
                                            <small>Get notified about new group invitations.</small>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" id="groupInvitesToggle" checked>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    <div class="settings-toggle-group">
                                        <div class="settings-toggle-label">
                                            <span>Device Disconnected</span>
                                            <small>Get notified when a device goes offline.</small>
                                        </div>
                                        <label class="switch">
                                            <input type="checkbox" id="deviceDisconnectedToggle" checked>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- Security & Privacy Section -->
                            <div class="settings-card">
                                <h2 class="settings-section-title">Security & Privacy</h2>
                                <p class="settings-section-desc">Manage your account security and privacy settings.</p>
                                <div class="settings-row">
                                    <div class="security-actions">
                                        <button class="security-btn" id="changePasswordBtn">
                                            <i class="fas fa-key"></i>
                                            <span>Change Password</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                        <button class="security-btn" id="twoFactorBtn">
                                            <i class="fas fa-mobile-alt"></i>
                                            <span>Two-Factor Authentication</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                        <button class="security-btn" id="privacySettingsBtn">
                                            <i class="fas fa-user-secret"></i>
                                            <span>Privacy Settings</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                        <button class="security-btn" id="dataExportBtn">
                                            <i class="fas fa-download"></i>
                                            <span>Download My Data</span>
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Account Management Section -->
                            <div class="settings-card">
                                <h2 class="settings-section-title">Account Management</h2>
                                <p class="settings-section-desc">Manage your account and session.</p>
                                <div class="settings-row">
                                    <button type="button" class="logout-btn" id="logoutBtn">
                                        <i class="fas fa-sign-out-alt"></i> Logout
                                    </button>
                                </div>
                            </div>

                            <!-- Save Button -->
                            <div class="settings-actions">
                                <button type="submit" class="save-settings-btn">
                                    <i class="fas fa-save"></i> Save Changes
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Add Device Modal -->
    <div id="addDeviceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Device</h2>
                <span class="close">&times;</span>
            </div>
            
            <div class="modal-body" id="modalBody">
                <!-- Dynamic content will be inserted here -->
            </div>
            
            <div class="modal-footer" id="modalFooter">
                <!-- Dynamic footer content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Step 3 Content -->
    <div id="step3Content" class="step-content">
        <!-- Content will be dynamically inserted here -->
    </div>

    <!-- Scripts -->
    <script>
        // Try to load QRCode library with multiple fallbacks
        function loadQRCode() {
            const scripts = [
                'https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js',
                'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js'
            ];
            
            let currentScript = 0;
            
            function tryLoadScript() {
                if (currentScript >= scripts.length) {
                    console.log('All QRCode script sources failed to load');
                    return;
                }
                
                const script = document.createElement('script');
                script.src = scripts[currentScript];
                script.onload = function() {
                    console.log('QRCode library loaded from:', scripts[currentScript]);
                };
                script.onerror = function() {
                    console.log('Failed to load QRCode from:', scripts[currentScript]);
                    currentScript++;
                    tryLoadScript();
                };
                document.head.appendChild(script);
            }
            
            tryLoadScript();
        }
        
        loadQRCode();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="{{ url_for('static', filename='js/Dashboard.js') }}"></script>
    <script src="{{ url_for('static', filename='js/profile.js') }}"></script>
    <script src="{{ url_for('static', filename='js/devices.js') }}"></script>
    <script src="{{ url_for('static', filename='js/friends.js') }}"></script>
    <script src="{{ url_for('static', filename='js/map.js') }}"></script>

    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <!-- Firebase Config and Auth Service -->
    <script src="/firebase_auth/web/firebase-config-cdn.js"></script>
    <script src="/firebase_auth/web/auth-service-cdn.js"></script>
    
    <script>
        // Loading Bar Controller
        class LoadingBar {
            constructor() {
                this.element = document.getElementById('loadingBar');
                this.progress = this.element.querySelector('.loading-progress');
                this.currentProgress = 0;
                this.isVisible = false;
            }

            show() {
                this.element.classList.add('active');
                this.isVisible = true;
                this.setProgress(0);
            }

            hide() {
                this.setProgress(100);
                setTimeout(() => {
                    this.element.classList.remove('active');
                    this.isVisible = false;
                    this.currentProgress = 0;
                    this.progress.style.width = '0%';
                }, 300);
            }

            setProgress(percent) {
                this.currentProgress = Math.min(100, Math.max(0, percent));
                this.progress.style.width = this.currentProgress + '%';
            }

            increment(amount = 10) {
                this.setProgress(this.currentProgress + amount);
            }

            startIndeterminate() {
                this.element.classList.add('active', 'indeterminate');
                this.isVisible = true;
            }

            stopIndeterminate() {
                this.element.classList.remove('indeterminate');
                this.hide();
            }
        }

        // Global loading bar instance
        window.loadingBar = new LoadingBar();

        // Utility functions for common loading scenarios
        window.showPageLoading = function() {
            window.loadingBar.startIndeterminate();
        };

        window.hidePageLoading = function() {
            window.loadingBar.stopIndeterminate();
        };

        window.simulateFormSubmission = function(callback, duration = 1500) {
            window.loadingBar.show();
            window.loadingBar.setProgress(10);
            
            let progress = 10;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                window.loadingBar.setProgress(Math.min(progress, 90));
                
                if (progress >= 90) {
                    clearInterval(interval);
                }
            }, duration / 10);

            setTimeout(() => {
                window.loadingBar.setProgress(100);
                clearInterval(interval);
                if (callback) callback();
                setTimeout(() => window.loadingBar.hide(), 300);
            }, duration);
        };

        // Auto-show loading bar for fetch requests (if using fetch)
        if (window.fetch) {
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                window.loadingBar.show();
                window.loadingBar.setProgress(20);
                
                return originalFetch.apply(this, args)
                    .then(response => {
                        window.loadingBar.setProgress(80);
                        return response;
                    })
                    .finally(() => {
                        window.loadingBar.setProgress(100);
                        setTimeout(() => window.loadingBar.hide(), 300);
                    });
            };
        }

        // Handle direct navigation to profile section
        function handleProfileNavigation() {
            if (window.location.hash === '#profile') {
                // Wait for sidebar navigation to be ready
                setTimeout(() => {
                    const profileLink = document.querySelector('.sidebar-link[data-page="profile"]');
                    if (profileLink) {
                        profileLink.click();
                    }
                }, 500);
            }
        }

        // Sidebar functionality
        document.addEventListener('DOMContentLoaded', function() {
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarClose = document.getElementById('sidebarClose');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const sidebarLinks = document.querySelectorAll('.sidebar-link[data-page]');

            // Toggle sidebar
            function toggleSidebar() {
                sidebar.classList.toggle('active');
                sidebarOverlay.classList.toggle('active');
                document.body.classList.toggle('sidebar-open');
            }

            // Close sidebar
            function closeSidebar() {
                sidebar.classList.remove('active');
                sidebarOverlay.classList.remove('active');
                document.body.classList.remove('sidebar-open');
            }

            // Event listeners
            sidebarToggle?.addEventListener('click', toggleSidebar);
            sidebarClose?.addEventListener('click', closeSidebar);
            sidebarOverlay?.addEventListener('click', closeSidebar);

            // Check for profile navigation on page load
            handleProfileNavigation();

            // Handle sidebar navigation
            sidebarLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Show loading bar
                    window.loadingBar.show();
                    
                    // Simulate loading progress
                    let progress = 0;
                    const progressInterval = setInterval(() => {
                        progress += Math.random() * 30;
                        window.loadingBar.setProgress(progress);
                        
                        if (progress >= 90) {
                            clearInterval(progressInterval);
                        }
                    }, 100);
                    
                    // Remove active class from all items
                    document.querySelectorAll('.sidebar-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    
                    // Add active class to clicked item
                    this.closest('.sidebar-item').classList.add('active');
                    
                    // Get the page data attribute
                    const page = this.getAttribute('data-page');
                    
                    if (page) {
                        // Simulate page load delay
                        setTimeout(() => {
                            // Hide all page content sections
                            document.querySelectorAll('.page-content').forEach(content => {
                                content.classList.remove('active');
                            });
                            
                            // Show the selected page content
                            const targetPage = document.getElementById(page + '-page');
                            if (targetPage) {
                                targetPage.classList.add('active');
                            }
                            
                            // Update page title
                            const pageTitle = document.querySelector('.page-title');
                            const pageName = this.querySelector('span').textContent;
                            if (pageTitle) {
                                pageTitle.textContent = pageName;
                            }
                            
                            // Hide loading bar
                            window.loadingBar.hide();
                            clearInterval(progressInterval);
                        }, 500 + Math.random() * 500); // Random delay between 500-1000ms
                    }
                    
                    // Close sidebar on mobile
                    if (window.innerWidth <= 768) {
                        closeSidebar();
                    }
                    
                    console.log('Navigating to:', page);
                });
            });

            // Close sidebar on window resize if mobile
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    closeSidebar();
                }
            });

            // Profile Page JavaScript
            initializeProfilePage();

            // Firebase auth state handling
            function updateNavbarUsername(user) {
                var name = '';
                if (user) {
                    name = user.displayName || user.email || 'User';
                }
                var nameSpan = document.getElementById('navbar-username');
                if (nameSpan) nameSpan.textContent = name;
            }
            
            // Initialize Firebase auth listener when available
            function initializeAuth() {
                if (window.firebase && window.firebase.auth) {
                    window.firebase.auth().onAuthStateChanged(updateNavbarUsername);
                } else if (window.authService && window.authService.onAuthStateChanged) {
                    window.authService.onAuthStateChanged(updateNavbarUsername);
                } else {
                    // Retry in 100ms if Firebase is not ready yet
                    setTimeout(initializeAuth, 100);
                }
            }
            
            initializeAuth();
        });

        // Profile Page Functions
        function initializeProfilePage() {
            const saveBtn = document.getElementById('saveChangesBtn');
            const shareBtn = document.getElementById('shareProfileBtn');
            const profileForm = document.getElementById('profileForm');
            const firstNameInput = document.getElementById('firstName');
            const lastNameInput = document.getElementById('lastName');
            const emailInput = document.getElementById('email');
            const profileNameDisplay = document.getElementById('profileName');
            const profileTagline = document.getElementById('profileTagline');
            const usernameDisplay = document.querySelector('.stat-value');

            // Fetch user info from Firebase Auth
            function populateUserProfile() {
                let user = null;
                if (window.firebase && window.firebase.auth) {
                    user = window.firebase.auth().currentUser;
                } else if (window.authService && window.authService.getCurrentUser) {
                    user = window.authService.getCurrentUser();
                }
                if (user) {
                    // Split displayName into first/last if possible
                    if (user.displayName) {
                        const [first, ...rest] = user.displayName.split(' ');
                        firstNameInput.value = first || '';
                        lastNameInput.value = rest.join(' ') || '';
                        profileNameDisplay.textContent = user.displayName;
                    }
                    if (user.email) {
                        emailInput.value = user.email;
                    }
                    // Username (use email prefix or UID as fallback)
                    let username = user.displayName || (user.email ? user.email.split('@')[0] : user.uid);
                    if (usernameDisplay) usernameDisplay.textContent = '@' + username.replace(/\s+/g, '').toLowerCase();
                }
            }

            // Wait for Firebase Auth to be ready
            function waitForFirebaseUser() {
                if ((window.firebase && window.firebase.auth && window.firebase.auth().currentUser) ||
                    (window.authService && window.authService.getCurrentUser && window.authService.getCurrentUser())) {
                    populateUserProfile();
                } else {
                    setTimeout(waitForFirebaseUser, 200);
                }
            }
            waitForFirebaseUser();

            // Update profile name when first/last name changes
            function updateProfileName() {
                const firstName = firstNameInput.value.trim();
                const lastName = lastNameInput.value.trim();
                const fullName = `${firstName} ${lastName}`.trim();
                if (fullName) {
                    profileNameDisplay.textContent = fullName;
                }
            }

            // Form validation
            function validateForm() {
                const firstName = firstNameInput.value.trim();
                const lastName = lastNameInput.value.trim();
                const email = document.getElementById('email').value.trim();
                
                if (!firstName || !lastName || !email) {
                    return false;
                }
                
                // Basic email validation
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }

            // Save changes handler
            saveBtn?.addEventListener('click', function(e) {
                e.preventDefault();
                
                if (!validateForm()) {
                    alert('Please fill in all fields with valid information.');
                    return;
                }

                // Show loading bar
                window.loadingBar.show();
                window.loadingBar.setProgress(20);

                // Show loading state
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                saveBtn.disabled = true;

                // Simulate API call with progress updates
                let progress = 20;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 15;
                    window.loadingBar.setProgress(progress);
                    
                    if (progress >= 90) {
                        clearInterval(progressInterval);
                    }
                }, 150);

                // Simulate API call
                setTimeout(() => {
                    // Complete loading bar
                    window.loadingBar.setProgress(100);
                    
                    // Reset button
                    saveBtn.innerHTML = originalText;
                    saveBtn.disabled = false;
                    
                    // Show success message
                    showSuccessMessage('Profile updated successfully!');
                    
                    // Update profile name display
                    updateProfileName();
                    
                    // Hide loading bar
                    window.loadingBar.hide();
                    clearInterval(progressInterval);
                }, 1500);
            });

            // Share profile handler
            shareBtn?.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Simulate sharing
                const profileUrl = `${window.location.origin}/profile/${document.getElementById('firstName').value.toLowerCase()}`;
                
                if (navigator.share) {
                    navigator.share({
                        title: 'My UniLocator Profile',
                        text: 'Check out my UniLocator profile!',
                        url: profileUrl
                    });
                } else {
                    // Fallback to clipboard
                    navigator.clipboard.writeText(profileUrl).then(() => {
                        showSuccessMessage('Profile link copied to clipboard!');
                    });
                }
            });

            // Real-time name update
            firstNameInput?.addEventListener('input', updateProfileName);
            lastNameInput?.addEventListener('input', updateProfileName);

            // Auto-save tagline
            profileTagline?.addEventListener('blur', function() {
                showSuccessMessage('Tagline updated!');
            });
        }

        // Settings Page JS
        (function() {
            const form = document.getElementById('settingsForm');
            if (!form) return;
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Show loading bar
                window.loadingBar.show();
                window.loadingBar.setProgress(15);
                
                const btn = form.querySelector('.save-settings-btn');
                const original = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                btn.disabled = true;
                
                // Simulate progress updates
                let progress = 15;
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 20;
                    window.loadingBar.setProgress(progress);
                    
                    if (progress >= 85) {
                        clearInterval(progressInterval);
                    }
                }, 120);
                
                setTimeout(() => {
                    // Complete progress
                    window.loadingBar.setProgress(100);
                    
                    btn.innerHTML = original;
                    btn.disabled = false;
                    showSuccessMessage('Settings saved!');
                    
                    // Hide loading bar
                    window.loadingBar.hide();
                    clearInterval(progressInterval);
                }, 1200);
            });
            // Optional: toggle switches visual feedback (already handled by CSS)
        })();

        // Helper function to show success messages
        function showSuccessMessage(message) {
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = 'success-toast';
            toast.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: var(--success);
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-weight: 600;
                z-index: 10000;
                opacity: 0;
                transform: translateX(100px);
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                gap: 8px;
            `;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.style.opacity = '1';
                toast.style.transform = 'translateX(0)';
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100px)';
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>