<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - UniLocator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/Dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/profile.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Particles background -->
    <div id="particles-js"></div>

    <!-- Navigation -->
    <nav>
        <div class="nav-content">
            <div class="logo">
                <i class="fas fa-map-marker-alt"></i>
                UniLocator
            </div>
            <div class="nav-tabs">
                <a href="{{ url_for('main.dashboard') }}" class="tab">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a href="{{ url_for('main.profile') }}" class="tab active">
                    <i class="fas fa-user"></i> Profile
                </a>
            </div>
            <div class="nav-actions">
                <a href="{{ url_for('main.dashboard') }}" class="nav-link">
                    <i class="fas fa-arrow-left"></i>
                    <span>Back to Dashboard</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main>
        <div class="profile-layout">
            <!-- Left Sidebar -->
            <div class="profile-sidebar">
                <div class="profile-avatar-section">
                    <div class="profile-avatar">
                        <i class="fas fa-user-circle"></i>
                    </div>
                    <div class="profile-names">
                        <h1 class="profile-name" id="profile-username">User</h1>
                        <p class="profile-handle" id="user-email">Loading...</p>
                    </div>
                    <p class="profile-bio">UniLocator User</p>
                </div>

                <div class="profile-stats">
                    <div class="stat-item">
                        <strong>{{ profile.device_count }}</strong>
                        <span>Connected Device{{ 's' if profile.device_count != 1 else '' }}</span>
                    </div>
                    <div class="stat-item">
                        <strong>0</strong>
                        <span>Locations Tracked</span>
                    </div>
                </div>

                <div class="profile-details">
                    <div class="detail-item">
                        <i class="fas fa-calendar"></i>
                        <span>Joined {{ profile.created_at.split(' ')[0] if profile.created_at != 'Unknown' else 'Recently' }}</span>
                    </div>
                    <div class="detail-item">
                        <i class="fas fa-id-card"></i>
                        <span>ID: {{ profile.user_id[:8] }}...</span>
                    </div>
                </div>

                <div class="profile-actions">
                    <button class="profile-action-btn logout-btn" onclick="logoutUser()">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Sign out</span>
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="profile-main">
                <div class="profile-nav">
                    <nav class="profile-tabs">
                        <button class="profile-tab active" data-tab="overview">
                            <i class="fas fa-chart-line"></i>
                            Overview
                        </button>
                        <button class="profile-tab" data-tab="devices">
                            <i class="fas fa-mobile-alt"></i>
                            Devices
                        </button>
                        <button class="profile-tab" data-tab="settings">
                            <i class="fas fa-cog"></i>
                            Settings
                        </button>
                        <button class="profile-tab" data-tab="security">
                            <i class="fas fa-shield-alt"></i>
                            Security
                        </button>
                    </nav>
                </div>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Overview Tab -->
                    <div class="tab-pane active" id="overview">
                        <div class="overview-grid">
                            <div class="overview-card">
                                <div class="card-header">
                                    <h3><i class="fas fa-mobile-alt"></i> Connected Devices</h3>
                                </div>
                                <div class="card-content">
                                    <div class="metric">
                                        <span class="metric-number">{{ profile.device_count }}</span>
                                        <span class="metric-label">Active devices</span>
                                    </div>
                                    <div class="device-list">
                                        {% if profile.devices %}
                                            {% for device in profile.devices %}
                                            <div class="device-item">
                                                <i class="fas fa-mobile-alt"></i>
                                                <span>{{ device.device_name or 'Unknown Device' }}</span>
                                                <span class="device-status">Online</span>
                                            </div>
                                            {% endfor %}
                                        {% else %}
                                            <div class="empty-state">
                                                <i class="fas fa-mobile-alt"></i>
                                                <p>No devices connected</p>
                                                <a href="{{ url_for('main.dashboard') }}" class="add-device-link">Add your first device</a>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="overview-card">
                                <div class="card-header">
                                    <h3><i class="fas fa-chart-area"></i> Activity</h3>
                                </div>
                                <div class="card-content">
                                    <div class="activity-chart">
                                        <div class="chart-placeholder">
                                            <i class="fas fa-chart-line"></i>
                                            <p>Activity tracking coming soon</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Devices Tab -->
                    <div class="tab-pane" id="devices">
                        <div class="devices-header">
                            <h3>Connected Devices</h3>
                            <a href="{{ url_for('main.dashboard') }}" class="btn-add-device">
                                <i class="fas fa-plus"></i> Add Device
                            </a>
                        </div>
                        
                        <div class="devices-list">
                            {% if profile.devices %}
                                {% for device in profile.devices %}
                                <div class="device-card">
                                    <div class="device-info">
                                        <div class="device-icon">
                                            <i class="fas fa-mobile-alt"></i>
                                        </div>
                                        <div class="device-details">
                                            <h4>{{ device.device_name or 'Unknown Device' }}</h4>
                                            <p>ID: {{ device.device_code }}</p>
                                            <p>Added: {{ device.created_at or 'Recently' }}</p>
                                        </div>
                                    </div>
                                    <div class="device-actions">
                                        <span class="status-badge online">Online</span>
                                        <button class="btn-remove" onclick="removeDevice('{{ device.device_code }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="empty-devices">
                                    <i class="fas fa-mobile-alt"></i>
                                    <h3>No devices connected</h3>
                                    <p>Connect your first device to start tracking locations</p>
                                    <a href="{{ url_for('main.dashboard') }}" class="btn-primary">
                                        <i class="fas fa-plus"></i> Add Device
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Settings Tab -->
                    <div class="tab-pane" id="settings">
                        <div class="settings-section">
                            <h3><i class="fas fa-user"></i> Profile Settings</h3>
                            <div class="setting-item">
                                <label>Display Name</label>
                                <div class="input-group">
                                    <input type="text" id="display-name" placeholder="Enter display name">
                                    <button class="btn-save" onclick="updateProfile()">Save</button>
                                </div>
                            </div>
                            
                            <div class="setting-item">
                                <label>Bio</label>
                                <div class="input-group">
                                    <textarea id="bio" placeholder="Tell us about yourself" rows="3"></textarea>
                                    <button class="btn-save" onclick="updateProfile()">Save</button>
                                </div>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h3><i class="fas fa-bell"></i> Notifications</h3>
                            <div class="setting-item">
                                <div class="setting-toggle">
                                    <span>Device connection alerts</span>
                                    <label class="toggle">
                                        <input type="checkbox" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="setting-item">
                                <div class="setting-toggle">
                                    <span>Location tracking notifications</span>
                                    <label class="toggle">
                                        <input type="checkbox">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h3><i class="fas fa-map-marker-alt"></i> Location Settings</h3>
                            <div class="setting-item">
                                <div class="setting-toggle">
                                    <span>Enable location tracking</span>
                                    <label class="toggle">
                                        <input type="checkbox" checked>
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="setting-item">
                                <label>Location update interval</label>
                                <select class="setting-select">
                                    <option value="5">5 minutes</option>
                                    <option value="10" selected>10 minutes</option>
                                    <option value="15">15 minutes</option>
                                    <option value="30">30 minutes</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Security Tab -->
                    <div class="tab-pane" id="security">
                        <div class="settings-section">
                            <h3><i class="fas fa-shield-alt"></i> Account Security</h3>
                            <div class="security-item">
                                <div class="security-info">
                                    <h4>Two-factor authentication</h4>
                                    <p>Add an extra layer of security to your account</p>
                                </div>
                                <button class="btn-secondary">Configure</button>
                            </div>
                            
                            <div class="security-item">
                                <div class="security-info">
                                    <h4>Password</h4>
                                    <p>Last changed: Never</p>
                                </div>
                                <button class="btn-secondary">Change</button>
                            </div>
                        </div>

                        <div class="settings-section danger-zone">
                            <h3><i class="fas fa-exclamation-triangle"></i> Danger Zone</h3>
                            <div class="danger-item">
                                <div class="danger-info">
                                    <h4>Disconnect all devices</h4>
                                    <p>This will remove all connected devices from your account</p>
                                </div>
                                <button class="btn-danger" onclick="disconnectAllDevices()">Disconnect All</button>
                            </div>
                            
                            <div class="danger-item">
                                <div class="danger-info">
                                    <h4>Delete account</h4>
                                    <p>Permanently delete your account and all associated data</p>
                                </div>
                                <button class="btn-danger" onclick="deleteAccount()">Delete Account</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="{{ url_for('static', filename='js/particles.js') }}"></script>
    <script src="{{ url_for('static', filename='js/particles-config.js') }}"></script>
    <script src="{{ url_for('static', filename='js/profile.js') }}"></script>

    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <!-- Firebase Config and Auth Service -->
    <script src="/firebase_auth/web/firebase-config-cdn.js"></script>
    <script src="/firebase_auth/web/auth-service-cdn.js"></script>
</body>
</html>
                </div>

                <div class="profile-content">
                    <div class="profile-section">
                        <h2><i class="fas fa-info-circle"></i> Account Information</h2>
                        <div class="info-grid">
                            <div class="info-item">
                                <label>User ID</label>
                                <span>{{ profile.user_id[:20] }}...</span>
                            </div>
                            <div class="info-item">
                                <label>Email</label>
                                <span id="user-email">Loading...</span>
                            </div>
                            <div class="info-item">
                                <label>Member Since</label>
                                <span>{{ profile.created_at.split(' ')[0] if profile.created_at != 'Unknown' else 'Unknown' }}</span>
                            </div>
                            <div class="info-item">
                                <label>Connected Devices</label>
                                <span>{{ profile.device_count }} device{{ 's' if profile.device_count != 1 else '' }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Logout Section -->
                    <div class="profile-section logout-section">
                        <button class="logout-btn" onclick="logoutUser()">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </button>
                    </div>

                    <div class="profile-section">
                        <h2><i class="fas fa-cogs"></i> Account Settings</h2>
                        <div class="settings-grid">
                            <div class="setting-item">
                                <div class="setting-info">
                                    <h3>Email Notifications</h3>
                                    <p>Receive notifications about device activity</p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="email-notifications" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="setting-item">
                                <div class="setting-info">
                                    <h3>Device Auto-Connect</h3>
                                    <p>Automatically connect new devices from trusted locations</p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="auto-connect">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="setting-item">
                                <div class="setting-info">
                                    <h3>Location History</h3>
                                    <p>Store device location history for better tracking</p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="location-history" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="profile-section">
                        <h2><i class="fas fa-shield-alt"></i> Security</h2>
                        <div class="security-actions">
                            <button class="security-btn">
                                <i class="fas fa-key"></i>
                                Change Password
                            </button>
                            <button class="security-btn">
                                <i class="fas fa-mobile-alt"></i>
                                Two-Factor Authentication
                            </button>
                            <button class="security-btn">
                                <i class="fas fa-download"></i>
                                Download Account Data
                            </button>
                        </div>
                    </div>

                    <div class="profile-section danger-zone">
                        <h2><i class="fas fa-exclamation-triangle"></i> Danger Zone</h2>
                        <div class="danger-actions">
                            <button class="danger-btn" onclick="disconnectAllDevices()">
                                <i class="fas fa-unlink"></i>
                                Disconnect All Devices
                            </button>
                            <button class="danger-btn" onclick="deleteAccount()">
                                <i class="fas fa-trash"></i>
                                Delete Account
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="{{ url_for('static', filename='js/particles.js') }}"></script>
    <script src="{{ url_for('static', filename='js/particles-config.js') }}"></script>
    <script src="{{ url_for('static', filename='js/profile.js') }}"></script>

    <!-- Firebase App (the core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <!-- Firebase Config and Auth Service -->
    <script src="/firebase_auth/web/firebase-config-cdn.js"></script>
    <script src="/firebase_auth/web/auth-service-cdn.js"></script>
    
    <script>
        function logoutUser() {
            console.log('[DEBUG] Logout button clicked');
            // Call Flask logout endpoint
            fetch('/logout', {
                method: 'POST',
                credentials: 'include'
            })
            .then(res => res.json())
            .then(data => {
                console.log('[DEBUG] Logout response:', data);
                if (data.success) {
                    // Sign out from Firebase
                    if (window.firebase && window.firebase.auth) {
                        window.firebase.auth().signOut().then(() => {
                            console.log('[DEBUG] Firebase signOut successful');
                            window.location.href = '/';
                        }).catch((error) => {
                            console.error('[DEBUG] Firebase signOut error:', error);
                            window.location.href = '/';
                        });
                    } else {
                        window.location.href = '/';
                    }
                } else {
                    console.error('[DEBUG] Logout failed:', data.error);
                    window.location.href = '/';
                }
            })
            .catch(error => {
                console.error('[DEBUG] Logout request failed:', error);
                window.location.href = '/';
            });
        }

        function disconnectAllDevices() {
            if (confirm('Are you sure you want to disconnect all devices? This action cannot be undone.')) {
                fetch('/devices/disconnect-all', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'include'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('All devices have been disconnected successfully.');
                        location.reload();
                    } else {
                        alert('Failed to disconnect devices: ' + data.message);
                    }
                })
                .catch(error => {
                    alert('Error disconnecting devices. Please try again.');
                    console.error(error);
                });
            }
        }

        function deleteAccount() {
            if (confirm('Are you sure you want to delete your account? This action cannot be undone and will remove all your data.')) {
                if (confirm('This will permanently delete all your devices and data. Are you absolutely sure?')) {
                    fetch('/auth/delete-account', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        },
                        credentials: 'include'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('Account deleted successfully.');
                            window.location.href = '/';
                        } else {
                            alert('Failed to delete account: ' + data.message);
                        }
                    })
                    .catch(error => {
                        alert('Error deleting account. Please try again.');
                        console.error(error);
                    });
                }
            }
        }
    </script>
</body>
</html>
